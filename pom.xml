#!groovy

def mavenHome
def javaHome

node {

    stage('Environment Setup') {
        echo "=== Environment Setup ==="
        
        javaHome = tool name: 'java-17', type: 'jdk'
        mavenHome = tool name: 'maven-3', type: 'maven'
        
        env.JAVA_HOME = javaHome
        env.PATH = "${javaHome}/bin:${mavenHome}/bin:${env.PATH}"
        
        sh 'java -version'
        sh 'mvn -version'
    }

    stage('Validate Project Structure') {
        echo "=== Validation Stage ==="

        sh "echo Current workspace files:"
        sh "ls -la"

        if (!fileExists('pom.xml')) {
            echo "❌ ERROR → pom.xml not found in workspace!"
            echo "Make sure your Jenkins job Workspace contains:"
            echo " /workspace/"
            echo "     pom.xml"
            echo "     src/main/java/"
            error "Pipeline stopped — pom.xml missing"
        }

        echo "✔ pom.xml found"
    }

    stage('Compile') {
        echo "=== Compile Stage ==="
        sh 'mvn clean compile'
    }

    stage('Test') {
        echo "=== Running Unit Tests ==="

        try {
            sh 'mvn test'
        } catch (e) {
            echo "❗ Tests failed but pipeline continues..."
        }

        junit 'target/surefire-reports/*.xml'
    }

    stage('Package') {
        echo "=== Packaging JAR ==="
        sh 'mvn package -DskipTests'
        sh 'ls -la target'
    }

    stage('Archive Artifacts') {
        echo "=== Archiving Artifacts ==="
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
    }

    stage('Done') {
        echo "Pipeline finished successfully!"
    }
}
